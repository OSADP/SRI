/*
 * author:	Robert Roth
 * desc:	Controller for editting of user accounts.
 * params:
 *			$scope 	- this is the scope of the controller.
 * 			$http 	- provides http requests.
 * 			$state 	- provides page state properties and functions.
 * 			user		- a resolved user loaded from our API.
 */

'use strict';


function UserProfile( $scope, User ) {
	// cache our controller
	var _this = this;
	// Assign the resolved user data to our scope
	_this.menu = {
		active: 'email'
	}
	_this.eventCatch = null;
	
	_this.initialize = function() {
		User.getProfile()
		.then( function( response ) {
			// add data to our controller's local scope
			_this.user = response.data;
			_this.confirmEmail = _this.user.email;
		});
	}
	
	// Methods:
	// Sends a PUT request to update our user
	_this.updateUser = function() {
		User.updateProfile( _this.user ).then( updateSuccess, updateFailed );
		
		function updateSuccess() {
			// Show an alert message on top for our users
			$scope.utility.showMessage({
				type: 'success',
				message: 'Successfully Updated!'
			});
		}
		
		function updateFailed() {
			// Show an alert message on top for our users
			$scope.utility.showMessage({
				type: 'error',
				message: 'Update Failed! Try again or contact administrator.'
			});
		}
	};
	
	_this.updateEmail = function() {
		if( _this.confirmEmail === _this.user.email ) {
			_this.updateUser();
		} else {
			// Show an alert message on top for our users
			$scope.utility.showMessage({
				type: 'error',
				message: 'Update Failed! Email and Confirm Email should match.'
			});
		}		
	}
	
	_this.reset = function() {
		_this.initialize();
	}
	
	_this.openDropdown = function( $event ) {
		_this.eventCatch = $event;
		$event.stopPropagation();
		$event.preventDefault();
		var parent = document.getElementById('rightMenu');
		parent.className = "open";
	}
	
	_this.toggleDropdown = function( $event ) {
		$event.stopPropagation();
		$event.preventDefault();
		var parent = document.getElementById('rightMenu');
		if( _this.eventCatch !== null ) {
			parent.className = 'open';
			_this.eventCatch = null;
			return false;
		} else {
			parent.className = ( parent.className == '' ) ? "open" : '';
		}
	}
	
	_this.closeDropdown = function( $event ) {
		var parent = document.getElementById('rightMenu');
//		parent.className = "";
	}
	

	// initialize our controller
	_this.initialize();
	
};