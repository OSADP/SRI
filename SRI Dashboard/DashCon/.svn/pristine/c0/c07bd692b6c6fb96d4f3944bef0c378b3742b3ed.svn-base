

'use strict';


angular.module('sri.controller.TruckPhoneInfo', [])
	.controller('TruckPhoneInfoCTRL', ['$scope', '$http', '$timeout', '$rootScope', function( $scope, $http, $timeout, $rootScope ) {
		$scope.truck = $scope.truck || {};
		$scope.truckInfo = $scope.truckInfo || {};
		$scope.truckInfo.data = $scope.truckInfo.data || {};
		
		$scope.$watch('truck.current', function( newValue, oldValue ) {
			// Disregard undefined value
			if( newValue == undefined ) return false;
			// Remove background color initially
			// Check if the value is different from the previous one
			if( newValue !== oldValue ) {
				var path = newValue.sequenceNumber + '/' + newValue.siteId;
				$http.get('/DashCon/resources/truck/' + path).then( getInfo );
			}
		});

		function getInfo( response ) {
			// Initiate loading bar to simulate a loading of data
			$scope.truckInfo.loading = ( response.data != '' ) ? true : false;
			// Change background color if data is available
			$scope.truckInfo.hasData = ( response.data != '' ) ? true : false;
			// Set this module's data to the response
			// NOTE: Make sure the API returns only 1 object
			$scope.truckInfo.data = response.data;
			if( response.data != '' ) {
				$rootScope.$broadcast('truckPhoneActive', response.data);
			}
			// Simulate end of loading by removing the animation
			$timeout( function() {
				$scope.truckInfo.loading = false;
			}, 1000);
		}
		
		$scope.$on('truckFeedNew', function(event, message) {
			console.info('TruckFeed Poll Broadcast: Captured');
			if( message.sequenceNumber == $scope.truck.current.sequenceNumber ) {
				// var path = message.timestamp + '/' + message.sequenceNumber + '/' + message.siteId;
				var path = message.sequenceNumber + '/' + message.siteId;
				$http.get('/DashCon/resources/truck/' + path).then( getInfo );
				if( typeof message.usdotNumber == 'string' && message.usdotNumber !== '' ) {
					$rootScope.$broadcast('phoneAppUSDOTNumberAvailable', message );
				}
			}
		})
		
	}]);