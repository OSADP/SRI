/*
 * author:	Robert Roth
 * desc:	Controller for creating users.
 * params:
 *			$scope 	  - this is the scope of the controller.
 * 			User 	- a factory that provides an API for users.
 * 			Site 	- a factory that provides an API for sites.
 * 			stateList	- a resolved list of all states from a JSON file.
 */

sri.controller = sri.controller || {};

sri.controller.CreateUser = function( $scope, User, Site, stateList, $filter ) {
	// Add resolved state list to our scope
	$scope.states = stateList;
	// Init user as object, avoids undefined
	var userDefaults = {
		userId: '',
		userPassword: '',
		firstName: '',
		lastName: '',
		email: '',
		siteId: ''	
	};
	
	$scope.user = angular.extend({}, userDefaults);
	// Set default state option selected
	$scope.selectedState = 'AL';
	$scope.selectedSite = 'Click to select Site';
	// Set default user role value
	$scope.groupId = 'user';
	
	// Methods:
	$scope.createUser = function() {
		// Set the selected state to our user object under
		// the stateId attribute
		$scope.user.stateId = $scope.selectedState;
		$scope.user.siteId = $scope.selectedSite;
		// Define our userGroup object and assign our
		// groupId model from our scope to it.
		$scope.user.userGroup = {};
		$scope.user.userGroup.groupId = $scope.groupId;
		
		User.create( $scope.user ).then( createSuccess, createFailed );
		
		function createSuccess() {
			// Notifyr ngDirective to display a success notification
			$scope.utility.showMessage({
				type: 'success',
				message: 'User was successfully created!'
			});
			// reset our data
			$scope.resetForm();
		}
		
		function createFailed() {
			// Notifyr ngDirective to display an error notification
			$scope.utility.showMessage({
				type: 'error',
				message: 'User creation failed!'
			});
		}
	}
	
	// Add a listener for any change to our userId model
	// TODO: setup a validation for userId from our database
	$scope.$watch('user.userId', function() {
		
	});
	
	// Function: Resets our form by setting some of
	// our model's attributes to blank and setting the
	// form back to "prestine", which means the form is
	// back to being "untouched".
	$scope.resetForm = function() {
		$scope.user = angular.extend({}, userDefaults);
		$scope.selectedState = 'AL';
		$scope.createForm.$setPristine();
	};
	
	// Get all sites available from the database
	// and pass the promise to our callback
	Site.getAll().then( loadSiteOptions );

	// Get the sites from the promise's data
	// and add it to the scope
	function loadSiteOptions( sites ) {
		$scope.sites = $filter('orderBy')(sites, 'name', false);
		$scope.selectedSite = $scope.sites[0];
		return $scope;
	}
	
}



