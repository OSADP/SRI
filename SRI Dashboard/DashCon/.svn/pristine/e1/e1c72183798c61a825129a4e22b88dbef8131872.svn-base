package sri.ws;

import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.sql.Timestamp;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import javax.imageio.ImageIO;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriBuilder;
import javax.ws.rs.core.UriInfo;

import sri.dao.TruckFeedDao;
import sri.dao.TruckFeedDaoImpl;
import sri.dao.WeightReportDao;
import sri.dao.WeightReportDaoImpl;
import sri.data.TruckFeed;
import sri.data.TruckFeedWimTimes;
import sri.data.WeightReport;

import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.WebResource;
import com.sun.jersey.api.client.config.ClientConfig;
import com.sun.jersey.api.client.config.DefaultClientConfig;
import com.sun.jersey.core.header.FormDataContentDisposition;
import com.sun.jersey.multipart.BodyPartEntity;
import com.sun.jersey.multipart.FormDataParam;
import com.sun.jersey.multipart.MultiPart;


@Path("truck")
public class TruckFeedResource {

	@Context
	protected UriInfo uriInfo;
	@Context
	protected HttpServletRequest req;
	@Context
	protected HttpServletResponse resp;
	
	private TruckFeedDao truckfeedDao = new TruckFeedDaoImpl();
	private WeightReportDao weightReportDao = new WeightReportDaoImpl();
	
	//LIST All TRUCKS
	@GET
    @Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
    @Produces({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
    public List<TruckFeed> listAllTrucks() {
		List<TruckFeed> allTrucks = truckfeedDao.listAllTrucks();
    	return allTrucks;
    }
	
	@GET @Path("{timestamp}")
    @Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
    @Produces({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
	public TruckFeed getTruckFeed(@PathParam("timestamp") Timestamp timestamp) {
		TruckFeed truckfeed = truckfeedDao.getTruckFeed(timestamp);
		return truckfeed;
	}
	
	/*
	 * @author	rothr
	 * @desc	Get a TruckFeed based on a timestamp, sequenceNumber, and siteId.
	 */		
	@GET 
	@Path("{timestamp}/{sequenceNumber}/{siteId}")
	@Produces({MediaType.APPLICATION_JSON})
	public TruckFeed getTruckFeed(
			@PathParam("timestamp") String timestamp, 
			@PathParam("sequenceNumber") String sequenceNumber,
			@PathParam("siteId") Integer siteId) {

		TruckFeed truckfeed = truckfeedDao.getTruckFeed(timestamp, sequenceNumber, siteId);
		return truckfeed;
	}
	
	/*
	 * @desc	Get a TruckFeed based on a sequenceNumber and siteId.
	 */		
	@GET 
	@Path("{sequenceNumber}/{siteId}")
	@Produces({MediaType.APPLICATION_JSON})
	public TruckFeed getTruckFeedBySequenceNumberAndSiteId(
			@PathParam("sequenceNumber") String sequenceNumber,
			@PathParam("siteId") Integer siteId) {

		TruckFeed truckfeed = truckfeedDao.getTruckFeedBySequenceNumberAndSiteId(sequenceNumber, siteId);
		return truckfeed;
	}
	
	@POST @Path("image")
	@Consumes({MediaType.MULTIPART_FORM_DATA, MediaType.APPLICATION_JSON})
	public Response insertTruckFeed(
			@FormDataParam("file") InputStream uploadedInputStream,
			@FormDataParam("file") FormDataContentDisposition fileDetail,
			@FormDataParam("id") Integer id,
			@FormDataParam("licensePlate") String licensePlate,
			@FormDataParam("driversLicense") String driversLicense,
			@FormDataParam("commercialDriversLicense") String commercialDriversLicense,
			@FormDataParam("vin") String vin,
			@FormDataParam("usdotNumber") String usdotNumber,
			@FormDataParam("latitude") Double latitude,
			@FormDataParam("longitude") Double longitude,
			@FormDataParam("sequenceNumber") String sequenceNumber
		) {

		// We also need a calendar object for timestamps:
		Calendar calendar = Calendar.getInstance();
		// For this example we're just using the current date and time:
		Date now = calendar.getTime();
		java.sql.Timestamp timestamp = new java.sql.Timestamp(now.getTime());
		
		String uploadedFileLocation = "c://sri-phone-images/" + id + ".jpg";
		
		TruckFeed truckfeed = new TruckFeed();
		truckfeed.setId(id);
		truckfeed.setLicensePlate(licensePlate);
		truckfeed.setDriversLicense(driversLicense);
		truckfeed.setCommercialDriversLicense(commercialDriversLicense);
		truckfeed.setVin(vin);
		truckfeed.setUsdotNumber(usdotNumber);
		truckfeed.setLatitude(latitude);
		truckfeed.setLongitude(longitude);
		truckfeed.setImageUrl(uploadedFileLocation);
		truckfeed.setTimestamp(timestamp.toString());
		truckfeed.setSequenceNumber(sequenceNumber);
		
		truckfeedDao.insertTruckFeed(truckfeed);
		
		try {
			OutputStream out = new FileOutputStream(new File(
					uploadedFileLocation));
			int read = 0;
			byte[] bytes = new byte[1024];
 
			while ((read = uploadedInputStream.read(bytes)) != -1) {
				out.write(bytes, 0, read);
			}
			out.flush();
			out.close();
		} catch (IOException e) {
 
			e.printStackTrace();
		}
		//truckfeedDao.insertTruckFeed(truckfeed);
		String output = "File uploaded to : " + uploadedFileLocation;
		
		return Response.status(200).entity(output).build();
	}
	
	@POST @Path("approachEnter")
	@Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
	@Produces({MediaType.APPLICATION_JSON})
	public Response postApproachEnter(TruckFeed _truckFeed) {

		TruckFeed truckFeed = truckfeedDao.insertTruckFeed(_truckFeed);
		return Response.status(200).entity(truckFeed).build();

	}
	
	@POST @Path("wimEnter")
	@Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
	public Response postWimEnter(TruckFeed truckFeed) {

		truckfeedDao.updateTruckFeedWimEntered(truckFeed);
		return Response.status(200).entity(truckFeed).build();

	}
	
	@POST @Path("wimLeave")
	@Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
	public Response postWimLeave(TruckFeed truckFeed) {

		TruckFeedWimTimes tfWimTimes = truckfeedDao.getTruckFeedWimTimes(truckFeed.getId());
		tfWimTimes.setWimLeft(truckFeed.getTimestamp());
		
		//TODO:  Shouldn't need this.
		tfWimTimes.setWimEntered(tfWimTimes.getWimEntered());

		WeightReport report = new WeightReport();
		report = weightReportDao.getWeight(tfWimTimes);
		
		if (report != null) {
			String sequenceNumber = report.getSequenceNumber().toString();
			truckFeed.setSequenceNumber(sequenceNumber);
			truckfeedDao.updateTruckFeedWimLeft(truckFeed);

			invokeCometServlet(truckFeed);
		} 


		return Response.status(200).entity(report).build();
	}
	
	public Response invokeCometServlet(TruckFeed report) {
		String URL = "http://localhost:8080/DashCon";

		ClientConfig config = new DefaultClientConfig();
		Client client = Client.create(config);
		WebResource webResource = client.resource(UriBuilder.fromUri(URL)
				.build());

        ClientResponse response = 
        	webResource.path("/truckFeedPoll")
				.queryParam("siteId", String.valueOf(report.getSiteId()))
		        .queryParam("timestamp", report.getTimestamp())
		        .queryParam("licensePlate", String.valueOf(report.getLicensePlate()))
		        .queryParam("commercialDriversLicense", String.valueOf(report.getCommercialDriversLicense()))
		        .queryParam("vin", report.getVin())
		        .queryParam("usdotNumber", String.valueOf(report.getUsdotNumber()))
		        .queryParam("latitude", String.valueOf(report.getLatitude()))
		        .queryParam("longitude", String.valueOf(report.getLongitude()))
		        .queryParam("sequenceNumber", String.valueOf(report.getSequenceNumber()))
				.post(ClientResponse.class, report);
        
		System.out.println("Response " + response.getEntity(String.class));
		System.out.println("Response " + response.toString());
        
        return Response.status(200).entity(report.toString()).build();
	}

	
	@POST @Path("feed")
	@Consumes({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
	public Response postTruckFeed(TruckFeed truckFeed) {
		truckfeedDao.insertTruckFeed(truckFeed);
		try{
			WeightReport report = 
				weightReportDao.getWimWeightForStationAndTime(
					truckFeed.getTimestamp(), truckFeed.getSiteId());
		}catch(Exception e){
			e.printStackTrace();
		}
		return Response.status(200).entity(truckFeed).build();
	}
	
	@POST @Path("multi")
	@Consumes("multipart/mixed")
	public Response postTruckFeed2(MultiPart multiPart) {
		
	    // First part contains a TruckFeed object
	    TruckFeed truckFeed = multiPart.getBodyParts().get(0).getEntityAs(TruckFeed.class);
	    System.out.println("id : " + truckFeed.getId());
	    System.out.println("license plate : " + truckFeed.getLicensePlate());
	    System.out.println("driver's license : " + truckFeed.getDriversLicense());
	    System.out.println("commercial driver's license : " + truckFeed.getCommercialDriversLicense());
	    System.out.println("vin : " + truckFeed.getVin());
	    System.out.println("usdot number : " + truckFeed.getUsdotNumber());
	    System.out.println("latitude : " + truckFeed.getLatitude());
	    System.out.println("longitude : " + truckFeed.getLongitude());
	    System.out.println("sequenct number: " + truckFeed.getSequenceNumber());

		// We also need a calendar object for timestamps:
		Calendar calendar = Calendar.getInstance();
		// For this example we're just using the current date and time:
		Date now = calendar.getTime();
		java.sql.Timestamp timestamp = new java.sql.Timestamp(now.getTime());
		truckFeed.setTimestamp(timestamp.toString());
		
	    // Insert our truck feed into our database:
		truckfeedDao.insertTruckFeed(truckFeed);
		
		// get the second part which is the truck image
	    BodyPartEntity bpe = (BodyPartEntity) multiPart.getBodyParts().get(1).getEntity();
	    boolean isProcessed = false;
	    String message = null;
	    try {
	      InputStream source = bpe.getInputStream();
	      BufferedImage bi = ImageIO.read(source);
	 
	      File file = new File(".\\received\\" + truckFeed.getId() + ".jpg");
	 
	      //storing the image to file system.
	      if (file.isDirectory()) {
	        ImageIO.write(bi, "jpg", file);
	      } else {
	        file.mkdirs();
	        ImageIO.write(bi, "jpg", file);
	      }
	      isProcessed = true;
	 
	    } catch (Exception e) {
	      message = e.getMessage();
	    }
	    if (isProcessed) {
	      return Response.status(Response.Status.ACCEPTED).entity("Attachements processed successfully.").type(MediaType.TEXT_PLAIN).build();
	    }
	    
	    return Response.status(Response.Status.BAD_REQUEST).entity("Failed to process attachments. Reason : " + message).type(MediaType.TEXT_PLAIN).build();
	}

}
