

'use strict';


angular.module('sri.controller.SaferLookup', [])
	.controller('SaferLookupCTRL', ['$scope', '$http', '$rootScope', function( $scope, $http, $rootScope ) {
		$scope.truck = $scope.truck || {};
		$scope.saferLookup = $scope.saferLookup || {};
		$scope.saferLookup.hasUSDOT = false;
		$scope.saferLookup.usdotNumber = $scope.saferLookup.usdotNumber || '';
		
		$scope.$watch('saferLookup.usdotNumber', function( newValue, oldValue ) {
			if( newValue !== oldValue ) {
				$scope.saferLookup.hasUSDOT = false;
				if( $scope.saferLookup.usdotNumber == $scope.truck.current.usdotNumber ) {
					$scope.saferLookup.hasUSDOT = true;
				}
			}
		})

		$scope.$watch('truck.current', function( newValue, oldValue ) {
			if( newValue == undefined ) return false;
			if( newValue !== oldValue ) {
				$scope.saferLookup.usdotNumber = '';
				$scope.saferLookup.hasUSDOT = false;
				$http.get('/DashCon/resources/usdot/' + newValue.sequenceNumber)
				.success( function( data ) {
					// assign false to lookup because this trigger
					// is for the changing of current truck
					loadUSDOTNumber( data, false );
				})
				.error( function() {
					$scope.saferLookup.usdotNumber = '';
					$scope.saferLookup.hasUSDOT = false;
				});
			}
		});
		
		$scope.saferLookup.searchSafer = function( lookup ) {
			// check if triggered by lookup or change of current truck			
		 	if( $scope.saferLookup.usdotNumber != '' && $scope.saferLookup.usdotNumber != undefined && $scope.saferLookup.usdotNumber != '' ) {
			 	$scope.saferLookup.loading = true;
				$http.get('/DashCon/resources/safer/' + $scope.saferLookup.usdotNumber )
				.success( function( data ){
					loadSafer( data, lookup );
				})
				.error( function( res ) {
				 	$scope.saferLookup.loading = false;
				 	alert('SAFER Lookup: US DOT Number does not exist.');
				});
		 	}
		}
		
		$scope.saferLookup.clearInput = function( $event ) {
			if( $event ) $event.stopPropagation();
			$http.delete('/DashCon/resources/usdot/' + $scope.truck.current.sequenceNumber)
			.success( function() {
				$scope.saferLookup.usdotNumber = '';
				$scope.saferLookup.hasUSDOT = false;
				$scope.truck.current.usdotNumber = undefined;
			})
			loadSafer();
		}
		
		$scope.saferLookup.saveUSDOTNumber = function( $event, manualEntered, userId ) {
			var saferLookup = $scope.saferLookup;
			var usdot= {};
			usdot.usdotNumber = saferLookup.usdotNumber;
			usdot.sequenceNumber = $scope.truck.current.sequenceNumber;
			usdot.manualEntered = manualEntered || 1;
			usdot.userId = userId || 'not implemented';
			
			if( usdot.usdotNumber !== '' ) {
				$http.post('/DashCon/resources/usdot', usdot)
				.success( function( response, status) {
					if( status == 201 ) {
						$scope.truck.current.hasUSDOT = true;
						$scope.truck.current.usdotNumber = usdot.usdotNumber;
						$scope.saferLookup.usdotNumber = usdot.usdotNumber;
						$scope.saferLookup.hasUSDOT = true;
//						TODO: Add notification for create USDOT Number
					} else if( status == 202 ) {
						$scope.truck.current.hasUSDOT = true;
						$scope.truck.current.usdotNumber = undefined;
						$scope.saferLookup.usdotNumber = undefined;
						$scope.saferLookup.hasUSDOT = true;
//						TODO: Add notification for updated USDOT Number
					}
				})
				.error( function( res ) {
					$scope.saferLookup.clearInput();
				});
			}
		}

		function loadUSDOTNumber( data, lookup ) {
			if( typeof data == 'object' && data.usdotNumber != undefined ) {
				$scope.saferLookup.usdotNumber = data.usdotNumber;
				$scope.saferLookup.hasUSDOT = true;
				$scope.truck.current.hasUSDOT = true;
				$scope.truck.current.usdotNumber = $scope.saferLookup.usdotNumber;
			} else {
				$scope.saferLookup.usdotNumber = '';
				$scope.saferLookup.hasUSDOT = false;
				$scope.truck.current.hasUSDOT = false;
				$scope.truck.current.usdotNumber = undefined;
			}
			// assign true to signify this is triggered by lookup
			$scope.saferLookup.searchSafer( lookup );
		}
		
		function loadSafer( data, lookup ) {
			// a bug happens when switching active truck quicker than
			// safer can respond and load safer values showing data
			// to the wrong truck feed, lookup != false helps prevent it
			// by ensuring the truck's usdot number is equal to the lookup
			if( lookup != false || $scope.truck.current.usdotNumber == $scope.saferLookup.usdotNumber ) {
				$rootScope.$broadcast('saferLookupSuccess', data );
				if( typeof data == 'object' && data.companyData != undefined ) {
					$scope.saferLookup.hasUSDOT = true;
					$scope.truck.current.hasUSDOT = true;
				} else {
					$scope.saferLookup.hasUSDOT = false;
					$scope.truck.current.hasUSDOT = false;
				}
			} else {
				$rootScope.$broadcast('saferLookupSuccess', {});
			}
		 	$scope.saferLookup.loading = false;
		}
		
		$scope.$on('phoneAppUSDOTNumberAvailable', function( event, message ) {
			$scope.saferLookup.usdotNumber = message.usdotNumber;
			$scope.saferLookup.saveUSDOTNumber();
		});
		
	}]);