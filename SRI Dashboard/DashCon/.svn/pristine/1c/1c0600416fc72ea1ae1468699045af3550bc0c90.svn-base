<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Phone Test</title>
	<link rel="stylesheet" href="../styles/login.css" />
	<script src="../vendor/angular/angular.js"></script>
</head>
<body ng-app="APP">
	
	<section class="container" ng-controller="truckfeedCTRL as tf">
		<h1>{{ title }}</h1>
		<br />
		<form action="" class="form-horizontal" novalidate style="width: 320px;">
			<div class="form-group">
				<label>ID:</label>
				<input class="form-control" type="text" ng-model="id"/>
			</div>
			<div class="form-group">
				<label for="">License Plate:</label>
				<input class="form-control" type="text" ng-model="licensePlate"/>
			</div>
			<div class="form-group">
				<label for="">Driver's License:</label>
				<input class="form-control" type="text" ng-model="driversLicense"/>
			</div>
			<div class="form-group">
				<label for="">Commericial Licese:</label>
				<input class="form-control" type="text" ng-model="commercialDriversLicense"/>
			</div>
			<div class="form-group">
				<label for="">Vehicle ID:</label>
				<input class="form-control" type="text" ng-model="vehicleId"/>
			</div>
			<div class="form-group">
				<label for="">Latitude:</label>
				<input class="form-control" type="text" ng-model="latitude"/>
			</div>
			<div class="form-group">
				<label for="">Longitude:</label>
				<input class="form-control" type="text" ng-model="longitude"/>
			</div>
			<div class="form-group">
				<label for="">Image:</label>
				<input type="file" file-model="truckImage" />
			</div>
			
			<div class="form-group">
				<button type="button" class="btn btn-success" ng-click="submitFeed()">Submit</button>
			</div>
		</form>
		<p class="">{{message}}</p>
	</section>
	
	<script>
		angular.module('APP', [])
			   .directive('fileModel',  ['$parse', function ($parse) {
			    return {
			        restrict: 'A',
			        link: function(scope, element, attrs) {
			            var model = $parse(attrs.fileModel);
			            var modelSetter = model.assign;
			            
			            element.bind('change', function(){
			                console.log('Image File changed.');
			                scope.$apply(function(){
			                    modelSetter(scope, element[0].files[0]);
			                });
			            });
			        }
			    };
				}])
				.controller('truckfeedCTRL', ['$scope', '$http', TruckFeedCTRL]);
		
		function TruckFeedCTRL( $scope, $http ) {
			$scope.title = "TruckFeed";
			
			$scope.submitFeed = function() {
				// Create our form data body
				var formData = new FormData();
				// Create a feed object to be sent as one part of the request
				var feed = {}
				feed.id = $scope.id;
				feed.licensePlage = $scope.licensePlate;
				feed.driversLicense = $scope.driversLicense;
				feed.commercialDriversLicense= $scope.commercialDriversLicense;
				feed.vehicleId = $scope.vehicleId;
				feed.longitude = $scope.latitude;
				// Append it to our form data
				formData.append('feed', feed);
				// The other half of the request is the truck's image
				formData.append('file', $scope.truckImage);
		        
				console.log(feed);
				console.log(formData);
						            
				$http.post('/DashCon/resources/truck/image', formData, {
		            transformRequest: angular.identity,
		            headers: {'Content-Type': undefined}
		        }).success(function(){
		        	$scope.message = "Success!";
		        }).error(function(){
		        	$scope.message = "Failed!";
		        });
			}
			

		}
	</script>
</body>
</html>