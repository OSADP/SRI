

'use strict';


angular.module('sri.controller.LicensePlateRdr', [])
	.controller('LicensePlateCtrl', ['$scope', '$http', 'service.Profile', '$timeout',
     function( $scope, $http, Profile, $timeout ) {
		$scope.truck = $scope.truck || {};
		var _this = this;		
		// set default values for reset and reference
		var lprDefaults = {
			id: '',
			timestamp: null,
			siteId: null,
			fileName: '',
			sequenceNumber: null,
			licensePlateNumber: null,
			state: ''
		}
		// instantiate our license plate object
		_this.data = angular.extend({}, lprDefaults);
		
		// call the license plate image when user changes active truck
		$scope.$watch('truck.current', function( newValue, oldValue ) {
			// Disregard undefined values
			if( newValue == undefined ) return false;
			if( newValue !== oldValue ) {
				var path = newValue.siteId + '/' + newValue.sequenceNumber;
				$http.get('/DashCon/resources/lpr/' + path).then(function( promise ) {
					_this.data = promise.data;
					pingImage( _this.data.id );
				}, function( err ) {
					_this.data = angular.extend({}, lprDefaults);
				});
			}
		});

		// long poll our truck feed servlet
		function pollLicensePlate( currentUser ) {
			$http.get('/DashCon/licensePlatePoll').success( function( data ) {
				// Disregard invalid entries
				if( data.timestamp !== null || data.timestamp !== "null" )
					// populate feeds based on current user's site id
					if( currentUser.siteId == data.siteId )
						// since this is a long poll method we need to match the data id
						// to the active truck, especially when truck feed switching is
						// set to 'Locked'
						if( $scope.truck.current.sequenceNumber == data.sequenceNumber ) {
							_this.data = data;
							pingImage( data.id );
						}
				pollLicensePlate(currentUser);
			}).error( function( err ) {
				console.log( err );
				_this.data = angular.extend({}, lprDefaults);
				pollLicensePlate(currentUser);
			});
		}

		Profile.getProfile().then( function( currentUser ) {
			pollLicensePlate( currentUser );
			$scope.userSiteId = currentUser.siteId;
		});
		
		function pingImage( id ) {
			var imageSrc = '/DashCon/dashboard/images/lpr/' + id + '.jpg';
			$http.get(imageSrc)
			.success( function() {
				// this avoids the $digest already in progress error
				// since we're using $apply()
				$timeout(function(){
					$scope.truck.current.hasLicensePlate = true;
					_this.data.hasImage = true;
					_this.data.image = _this.data.id + '.jpg';
				})

			})
			.error( function() {
				if( id === _this.data.id )
					$timeout( function() {
						pingImage( id );
					}, 1500)
				else
					return false;
			})
		}
		
		
	}]);