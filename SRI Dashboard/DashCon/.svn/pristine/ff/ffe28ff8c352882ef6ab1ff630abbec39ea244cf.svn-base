

'use strict';


angular.module('sri.controller.SaferLookup', [])
	.controller('SaferLookupCTRL', ['$scope', '$http', '$rootScope', function( $scope, $http, $rootScope ) {
		$scope.truck = $scope.truck || {};
		$scope.saferLookup = $scope.saferLookup || {};
		$scope.saferLookup.hasUSDOT = false;
		$scope.saferLookup.usdotNumber = $scope.saferLookup.usdotNumber || '';
		
		$scope.$watch('saferLookup.usdotNumber', function( newValue, oldValue ) {
			if( newValue !== oldValue ) {
				$scope.saferLookup.hasUSDOT = false;
				if( $scope.saferLookup.usdotNumber == $scope.truck.current.usdotNumber ) {
					$scope.saferLookup.hasUSDOT = true;
				}
			}
		})

		$scope.$watch('truck.current', function( newValue, oldValue ) {
			if( newValue == undefined ) return false;
			if( newValue !== oldValue ) {
				$scope.saferLookup.usdotNumber = '';
				$scope.saferLookup.hasUSDOT = false;
				$http.get('/DashCon/resources/usdot/' + newValue.sequenceNumber)
				.success( loadUSDOTNumber )
				.error( function() {
					$scope.saferLookup.usdotNumber = '';
					$scope.saferLookup.hasUSDOT = false;
				});
			}
		});
		
		$scope.saferLookup.searchSafer = function() {
		 	if( $scope.saferLookup.usdotNumber != '' && $scope.saferLookup.usdotNumber != undefined ) {
			 	$scope.saferLookup.loading = true;
				$http.get('/DashCon/resources/safer/' + $scope.saferLookup.usdotNumber )
				.success( loadSafer )
				.error( function( res ) {
				 	$scope.saferLookup.loading = false;
				 	alert('SAFER Lookup: US DOT Number does not exist.');
				});
		 	}
		}
		
		$scope.saferLookup.clearInput = function( $event ) {
			if( $event ) $event.stopPropagation();
			$scope.saferLookup.usdotNumber = '';
			loadSafer();
		}
		
		$scope.saferLookup.saveUSDOTNumber = function( $event, manualEntered, userId ) {
			var saferLookup = $scope.saferLookup;
			var usdot= {};
			usdot.usdotNumber = saferLookup.usdotNumber;
			usdot.sequenceNumber = $scope.truck.current.sequenceNumber;
			usdot.manualEntered = manualEntered || 1;
			usdot.userId = userId || 'not implemented';
			
			if( usdot.usdotNumber !== '' ) {
				$http.post('/DashCon/resources/usdot', usdot)
				.success( function( response, status) {
					if( status == 201 ) {
						$scope.truck.current.hasUSDOT = true;
						$scope.truck.current.usdotNumber = usdot.usdotnumber;
						$scope.saferLookup.usdotNumber = usdot.usdotNumber;
						$scope.saferLookup.hasUSDOT = true;
//						TODO: Add notification for create USDOT Number
					} else if( status == 202 ) {
						$scope.truck.current.hasUSDOT = true;
						$scope.truck.current.usdotNumber = usdot.usdotnumber;
						$scope.saferLookup.usdotNumber = usdot.usdotNumber;
						$scope.saferLookup.hasUSDOT = true;
//						TODO: Add notification for updated USDOT Number
					}
				})
				.error( function( res ) {
					$scope.truck.current.usdotNumber = '';
					$scope.saferLookup.clearInput();
				});
			}
		}

		function loadUSDOTNumber( data ) {
			if( typeof data == 'object' && data.usdotNumber != undefined ) {
				$scope.saferLookup.usdotNumber = data.usdotNumber;
				$scope.saferLookup.hasUSDOT = true;
				$scope.truck.current.hasUSDOT = true;
				$scope.truck.current.usdotNumber = $scope.saferLookup.usdotNumber;
			} else {
				$scope.saferLookup.usdotNumber = '';
				$scope.saferLookup.hasUSDOT = false;
				$scope.truck.current.hasUSDOT = false;
				$scope.truck.current.usdotNumber = undefined;
			}
			$scope.saferLookup.searchSafer();
		}
		
		function loadSafer( data ) {
			$rootScope.$broadcast('saferLookupSuccess', data );
			if( typeof data == 'object' && data.companyData != undefined ) {
				$scope.saferLookup.hasUSDOT = true;
				$scope.truck.current.hasUSDOT = true;
			} else {
				$scope.saferLookup.hasUSDOT = false;
				$scope.truck.current.hasUSDOT = false;
			}
		 	$scope.saferLookup.loading = false;
		}
		
		$scope.$on('phoneAppUSDOTNumberAvailable', function( event, message ) {
			$scope.saferLookup.usdotNumber = message.usdotNumber;
			$scope.saferLookup.saveUSDOTNumber();
		});
		
	}]);